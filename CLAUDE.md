# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

**Язык общения в этом проекте — русский.**

## Обзор проекта

**iPhone Terminal Ultra Setup** — Bash-инсталлятор, который настраивает Linux-сервер для продуктивной работы через iPhone SSH-клиент (Termius). Разворачивает конфиг tmux, алиасы шелла, установку Claude Code и плагины сохранения сессий, оптимизированные для мобильного терминала.

**Это не компилируемый проект** — shell-скрипты без системы сборки, тестов и линтера.

## Запуск

```bash
bash setup.sh
```

Инсталлятор интерактивный, все промпты `[Y/n]` — по умолчанию "да" (можно просто жать Enter). Запускать **вне tmux**. Автоматически определяет ОС и пакетный менеджер (apt/dnf/yum/apk/brew).

## Структура репозитория

- `setup.sh` — Основной интерактивный инсталлятор (~518 строк). Определение системы, установка пакетов, деплой конфигов, установка плагинов.
- `iphone-terminal-setup.md` — Пошаговая инструкция для ручной установки + шпаргалка по горячим клавишам (альтернатива setup.sh).
- `.claude/settings.local.json` — Конфиг разрешений Claude Code (в gitignore).

## Архитектура setup.sh

Скрипт использует `set -euo pipefail` + `trap ERR` для обработки ошибок. Работает как линейный пайплайн:

1. **Анализ системы** — определяет ОС, пакетный менеджер, шелл (bash/zsh/fish), установленные инструменты (tmux, git, claude)
2. **Настройки пользователя** — запрашивает путь к проектам (по умолчанию `/opt`), нормализует путь, раскрывает `~`
3. **Выбор компонентов** — все промпты `[Y/n]` с дефолтом "да", включая установку Claude Code
4. **Бэкап** — создаёт резервную копию конфигов в `~/.terminal-setup-backup-<timestamp>/` с `chmod 700`
5. **Установка пакетов** — ставит tmux/git/Claude Code через определённый пакетный менеджер (`install_pkg()`)
6. **Деплой конфигов** — дописывает алиасы/функции/меню логина в RC-файл шелла, создаёт `~/.tmux.conf`
7. **Установка плагинов** — клонирует tmux-resurrect и tmux-continuum (с проверкой `.git`), настраивает крон (с дедупликацией)
8. **Финализация** — применяет конфиги и выводит шпаргалку

Ключевые решения:
- Tmux prefix — `Ctrl+A` (не дефолтный `Ctrl+B`) для удобства на iPhone
- Переключение окон стрелками (prefix + Up/Down) вместо цифр
- Переключение панелей через Alt+стрелки (без prefix)
- Проекты живут в `/opt` по умолчанию с табом через функции `p` и `np`
- `p` без аргументов показывает список проектов, с несуществующим — подсказывает доступные
- Автосохранение сессий через tmux-continuum каждые 10 минут; крон чистит сохранения старше 60 минут
- Claude Code ставится через `curl -fsSL https://claude.ai/install.sh | bash` если не найден
- Меню логина поддерживает attach, new, rename и быстрый вход по имени

## Разворачиваемые алиасы

| Алиас | Раскрывается в |
|-------|----------------|
| `c` | `claude` |
| `cr` | `claude --resume` |
| `cc` | `claude --continue` |
| `q` | `claude -p` |
| `tl` | `tmux ls` |
| `tk` | `tmux kill-session -t` |
| `p` | список проектов / `cd <dir> && ls` |
| `np <имя>` | `tmux new -s <имя> -c <dir>/<имя>` |

## Важное при работе с кодом

- Весь пользовательский текст в setup.sh на **русском** — сохраняй это при изменениях
- Скрипт использует `set -euo pipefail` + `trap ERR` — ошибки ловятся с номером строки
- Все переменные должны быть в кавычках (особенно пользовательский ввод в tmux-командах)
- Деплой конфигов: `cat >>` (дописывание) для shell RC и `cat >` (перезапись) для tmux.conf
- В heredoc для shell RC: `$PROJECTS_DIR` раскрывается при записи, `\$1`, `\$sess` — экранируются для рантайма
- `install_pkg()` — абстракция для кроссплатформенной установки пакетов
- Хелпер-функции (`info`, `warn`, `error`, `header`) — цветной вывод в терминал
- Плагины проверяются по наличию `.git` внутри папки (а не просто папки) — частично скачанные переклонируются
- Crontab: перед добавлением проверяется `grep -q` чтобы не дублировать записи
